---
layout: post
title:  "Bitcoin"
date:   2018-05-21 22:00:00 +1200
categories: posts
---

# 比特币：一种端到端(p2p)电子现金系统

摘要：一个纯粹的p2p版本的电子现金会允许一方向另一方发送在线支付而不经过金融机构。数字签名解决了部分问题，但如果仍然需要一个受信的第三方来阻止双重花费，就得不偿失了。我们提出一个用p2p网络解决双重花费问题的方案。这个网络通过计算交易的哈希值，把它们加入到一个不断增长的工作量证明(proof-of-work) 链中，并加上时间戳。这样就形成了一条不重新计算工作量证明就不能被修改的记录。最长的链不仅充当已经被见证的事件序列的证明，它还能证明自己来自于最大的CPU能力池。只要不协作攻击该网络的节点控制了大部分CPU能力，它们就会生成最长的链并且抵御攻击。该网络本身结构很简单。消息被尽力而为地广播，节点可以任意的离开或加入网络，它们接受最长的工作量证明链作为离开时所发生一切的证明。

## 1. 介绍

互联网上的贸易已经发展为几乎完全依赖金融机构作为受信第三方来处理电子支付。尽管这套系统对于大部分交易运行良好，但是基于信任的模型的内在弱点仍然给它带来诸多问题。完全不可逆交易并不能真的做到，因为金融机构不能避免调解争议。调解的开销增加了交易的开销，进而限制了最小可行交易的大小，使得小额随意交易的可能性消失，而且，失去为不可逆服务进行不可逆支付的能力，还引入了更大的开销。由于有可能逆转，对信任的需求更甚。商家必须警惕它们的客户，向他们索要更多本来不需要的信息。一定比例的欺诈被视作不可避免。通过使用物理货币面对面交易可以避免这些开销和支付的不确定性，但是，在没有受信方的通信线路上进行支付的机制是不存在的。
我们需要一种基于密码学证据而不是信任的电子支付系统，允许任意有意愿的两方与彼此直接交易，而不需要一个受信任的第三方。交易的逆转在计算上不可行，这样就能保护卖家免于欺诈，并且很容易就能实现常规的契约机制来保护买家。在这篇论文中，我们提出一个解决双重花费问题的方案，它使用分布式时间戳服务器来生成交易时序的计算证明。只要诚实的节点比任何串通的攻击节点能共同控制更多的算力，这个系统就是安全的。

## 2. 交易

我们将电子币定义为数字签名组成的链。持币者给前一个交易的哈希以及下一个持有者的公钥数字签名并添加到币的末尾，把币转给下一个人。收款人可以验证签名来验证链的所有权。当然，这里有个问题：收款人不能验证持有人之一没有双重花费该币。常见方案是引入一个受信的中央权威，或造币厂，检查每笔交易是否双重花费。每笔交易后，该币必须退还到铸币厂来发行一个新币，并且只有从铸币厂直接发行的币才被信任为不会双重支付。这个方案的问题在于，整个金钱系统的命运都依赖于运营铸币厂的公司。每笔交易都必须经过它们，就像是银行一样。
我们需要一种方法，让收款人知道前任持有人没有签署任何更早的交易。为了我们的目标，最早的交易才是重要的那一个，因此我们不关心后来的双重支付尝试。确认一个交易不存在的唯一方法，就是知道所有交易。在给予铸币厂的模型中，铸币厂知道所有交易并判定谁先到达。要在没有受信方的情况下实现这一点，交易必须公开宣布，并且我们需要一个系统让参与者认可它们收到顺序的唯一历史。收款方需要证据证明：在交易发生的时刻，多数节点同意它是第一个收到的。

## 3. 时间戳服务器

我们提出的方案首先需要一个时间戳服务器。时间戳服务器给等待盖时间戳的一个区块的条目计算哈希，并广泛的公布该哈希，比如在报纸上或者 Usenet post。 时间戳证明当时数据必定已经存在，进而计算进哈希。每个时间戳包含了哈希里的前一个时间戳，形成一个链，每个新增的时间戳增强了它前面的那些。

## 4. 工作量证明(Proof-of-Work)

要在端到端的基础上实现分布式时间戳服务器，我们将需要使用一个与 Adam Back 的 Hashcash 类似的工作量证明系统， 而不是报纸或者 Usenet posts。 工作量证明包括寻找一个值， 它在进行哈希计算后， 比如 SHA-256， 其哈希以一定数目的 0 开头。 要求的工作量与要求的 0 的个数成指数关系， 并且能够通过执行单个哈希验证。

对于我们的时间戳网络， 我们通过递增区块里的一个 nonce 直到区块中出现符合要求的 0 来实现工作量证明。 一旦 CPU 的努力被花费出去以满足工作量证明， 区块就无法在不重新计算的情况下被修改。 由于后续区块在它后面成链， 改变区块所需的工作量将包括对所有后续区块重新计算。

工作证明也解决了在多数人决策模型中确定代表性的问题。如果人数的判定是基于一IP一票，那么它就可能被任何能够分配大量IP的人说破坏。工作量证明本质上是一CPU一票。 多数人的决定是通过最长的链表示，而它投入最大的工作量证明。如果大部分算力被诚实节点控制，那么诚实的那条链将会增长最快并且超过任何竞争链。要修改过去的区块，一名攻击者将需要重做该区块以及其后所有区块的工作量证明，然后赶上并且超过诚实节点的工作量。我们稍后会展示：一个较慢的攻击者赶超的概率随着后续节点的加入而呈指数衰减。

为补偿硬件速度增加以及长期运行节点的兴趣变化，工作量证明的难度会由一个与每小时平均区块个数相关的变化的均值来决定。如果生成速度太快，那么难度系数就会增加。

## 5. 网络

运行网络的步骤如下：
1）新交易会广播给所有节点
2）所有节点将新交易收集到一个区块中
3）每个节点都开始为自己的区块寻找一个有难度的工作量证明
4）当一个节点找到，它就把自己的区块广播给所有节点
5）如果区块中的所有交易有效并且没有被花掉，则其余节点接受该区块
6）其余节点使用被接受区块的哈希作为前一个哈希，开始创建下一个区块，以此来表达它们的接受

节点总是认为最长的链是正确的那个，并且不断扩展它。如果两个节点同时广播了不同版本的区块，有些节点可能会首先收到其中一个或另一个。此时，它们在先收到的区块上工作，但也保存另一个分支以防止它变得更长。一旦下一个工作量证明被找到并且一个分支变得更长，平局就被打破。在另一个分支上工作的节点就会切换到更长的分支。

新交易广播并不需要抵达所有节点。只有它们抵达足够多的节点，不久它们就会被放入一个区块。区块广播对丢失的消息也是宽容的。如果一个节点没有收到一个区块，它会在收到下一个区块时意识到它丢了一个并且请求该区块。

## 6. 激励

按照约定，区块中的第一笔交易将是一个特殊的交易：它创建一个新币，并归区块的创建者所有。这个机制给节点支持网络增加了一种激励，并提供了一种分发新币进入流通的途径，因为没有中央机构发行它们。固定量的新币的稳定加入，与矿工花费资源将金子加入流通很类似。在我们的情况里，花费的是CPU时间和电力。

激励还可以通过交易费建立。如果交易的输出值小于输入值，差额将作为交易费加入到包含该交易的区块的激励中。一旦一定量的币进入流通，激励可能全部变成交易费并且不会通胀。

激励能帮助鼓励节点保持忠诚。如果一个贪婪的攻击者能够集结更多算力，他将必须面临一个抉择：是用算力去偷回他的支付来欺骗别人，还是用它来生成新币。他会发现按规则玩利润更高，他将得到比别人加起来还要多的新币，而不是去破坏系统，使他自己的财富失效。

## 7. 回收磁盘空间

一旦一个币最近的交易被足够多的区块掩埋，在它之前的已花费交易可以被丢弃以节省磁盘空间。要利用这点而不破坏区块的哈希，交易是用 Merkle Tree 来哈希的，仅有根包含在区块哈希里。旧的区块可以通过砍掉树枝来压实。内部哈希不需要存储。

没有交易的区块头大约80字节。如果我们假设每10分钟生成一个区块，80 bytes * 6 * 24 * 365 = 4.2MB每年。当下的2008年，在售的电脑系统通常有2G内存，并且摩尔定律预测每年增长1.2GB，即使所有的区块头信息都必须保存在内存中，存储都不会是一个问题。

## 8. 简单支付验证

即使不运行完整的网络节点，验证支付也是可行的。一个用户仅需保存最长链的区块头的副本。他可以通过查询网络节点，知道他相信他有了最长的链，并且得到Merkle分支。他自己不能检查交易，当通过把它链接到链里某个位置，他可以看到某个网络节点已经接收了它，且后续加入的区块进一步确认网络已经接受了它。

这样一来，只要忠诚的节点控制着网络，验证就是可靠的，但在攻击者压制了网络时，它也更脆弱。当网络节点能自己验证交易，这种简化的方法可能会被攻击者的伪造交易骗过。一种防止的策略是：接收来自其它网络节点的警告，当它们检测到无效区块，就提醒用户的软件去下载完整的区块和被警告的交易来确认不一致。对于接收频繁支付的业务，最好是运行自己的节点，已得到更加独立的安全和更快的验证。

## 9. 合并与分割币值

尽管分别处理币是可能的，但给一次转账的每一分钱创建一个独立的交易将是非常笨拙的。为了允许币值被分割和合并，一个交易会包含多个输入和输出。通常，要么只有来自之前某个更大的交易的单个输入，或者混合了多个较小额度的多个输入，以及至多两个输出：一个是支付，另一个是找给发送者的零钱，如果有的话。

一个交易依赖于几个其它交易，且那些交易又依赖更多其它交易，这称之为交易的展开。值得注意的是，展开并不是一个问题。我们永远不会需要提取一个交易的历史的完整独立的副本。

## 10. 隐私

传统的银行模型通过限制对交易参与各方以及受信第三方的信息访问来实现一定程度的隐私保护。在我们的模型中，由于需要公开发布所有交易，故而这种方法不再可行。但我们仍然可以通过在别的地方截断信息流来达到保护隐私的目的：通过保持公钥匿名。公众可以看到某个人正在发送一定额度给另一个人，但是却缺少将交易与任何人建立联系的信息。这与股票交易的信息披露级别类似：每个交易的时间和大小被公开，但是并不告知背后是谁。

作为附加的防火墙，每个交易都应该使用一对新的密钥，以防止它们与某个共同的持有人建立联系。对于多输入交易，某些联系仍然是不可避免的：它揭示了这些输入是由同一个人持有。风险在于，一旦密钥的主人被揭露，人们可以发现其它属于同一个主人的交易的联系。

## 11. 计算

我们来考虑这样的场景：一个攻击者试图比忠诚链更快的生成一个替代链。