---
layout: post
title:  "写给小白看的非对称加密原理"
date:   2018-09-04 00:00:00 +1200
categories: posts
---

## 对称加密

使用HTTP通信, 就好像一个男同学给教室另外一角的女朋友传纸条。这中间要经过若干个人,(而且你不能预测传递的路径).
任何一个人只要打开对折的纸条看一眼，就知道你说了啥。 这叫明文传输.

一开始同学们都很淳朴友善，没有人会偷看你们的纸条。但是时间久了开始有人不老实，比如坐在你们中间的某个人成了你的情敌.

为了保护隐私以及防止篡改，你们决定对消息的内容加密。假如你们使用的是英文，你们约定，写纸条的人将每个字母都替换为字母表的下一个字母。
收到纸条的人根据这个规则把信息还原。这样别人看到的就是一些奇怪的单词，不知道你们在说什么。这叫对称加密.

很快有人知道了你们的约定，比如你们商量时被偷听了，比如你把约定写在纸上被人偷看了，比如你不小心说漏了嘴, 或者对方很聪明，看了很多你们的纸条内容后猜出了规则.
一开始你觉得也许是规则太简单，于是变更了很多次规则。但是这种基于双方约定的方法时间久了总会被人知道.
最后你决定使用非对称加密.

## 非对称加密

非对称加密使用一对密钥，一个公开，一个私有.
可以用 `ssh-keygen` 命令生成，并且可以添加额外的密码来保护私钥.
用其中一个对信息加密，理论上只有另外一个可以解密.
从私钥可以推断出公钥，反之则不行。

你和女朋友各自生成了一对密钥，公钥部分你们可以大方的写在纸条上告诉对方，被人知道了也没关系。

而私钥部分，你们各自保管在只有自己一个人知道的最隐秘的地方，没有任何其他人知道.
不放心的话还可以再加一层密码保护起来，比如加个密码锁。

当你想给女朋友发消息，你就找到她的公钥对消息进行加密，然后还是用纸条传出去。
中间偷看的人这次蒙圈了，因为内容看起来是乱码，完全不知道说的啥。

你女朋友收到纸条后，用自己藏好的私钥偷偷解密，就知道了你想说啥。
当她给你回复消息时，也如法炮制，用你的公钥加密，你收到后用自己的私钥解密。

## 数字签名
上面的例子展示了非对称加密的一个应用场景：用公钥加密，私钥解密，实现信息加密。
如果反过来，用私钥加密，公钥解密，则得到另一个应用场景：数字签名.



不过这里还有另外一个问题：由于你们俩的公钥是公开的(比如高调的你直接把两人的公钥写在了教室后面的黑板上),
任何人都可以用你女朋友的公钥加密消息发给她.
为了表明消息是你的，你需要在消息后面署名.
光署名了还不够，为了防止别人冒充, 你还要加上自己特殊的签名。

在物理世界里, 署名和签名可以是同一个。
但署名必须工整清晰易于辨认，而签名为了防止模仿，最好是龙飞凤舞不知所云，甚至不需要是真的名字(比如按手印, 或者画个圈圈)。
在正式的场合(比如合同)，二者肯定是分开的。署名可以提前打印好，而签名必须本人亲自单独填写(仿造，代写都是无效的，不做讨论)。

前面提到，公钥和私钥其中任何一个都可以用来加密, 另一个用来解密。
公钥加密，私钥解密，可以确保发给你的消息只有你自己能解读。
而反过来，私钥加密，公钥解密，则可以用来证明这个消息来自你，也就是数字签名.
比如发送这样一条带有数字签名的消息(为简化问题，假如消息是明文)：

    朱茵茵:

        我要跟你分手.

    周星星

    bc:a4:a1:c6:5b:14:ed:73:ca:a2:7e:9c:6a:5f:f9:9b:ff:36:
    9c:29:21:8c:c1:5a:e7:2c:12:fe:10:4e:bd:87:72:e2:8a:e5:
    34:cb:0c:18:40:95:be:d4:4e:49:95:4e:7f:14:f2:73:aa:56:
    29:f9:e4:34:02:ef:b9:8e:6b:72:6f:65:f1:ed:48:a2:78:73:

朱茵茵收到消息，不确定是不是有人恶作剧. 于是她找到周星星的公钥(比如看看教室后面的黑板)，对署名后的签名解密，发现解密后正是"周星星"三个字，因此相信这段文字来自周星星。

## 数字证书

还是上面的例子，假如周星星的情敌决心拆散他们.
他先是生成一对自己的密钥，然后趁月黑风高偷偷潜入教室，把后面黑板上周星星的公钥改成了自己的公钥, 神不知鬼不觉。
第二天, 他写了上面的分手信，署上"周星星"的大名，然后用自己的私钥签名。
朱茵茵收到信后校验签名，发现真的是他，遂生气分手, 老死不相往来。

这里引出了另外一个问题：我如何相信我从公共场合获取的公钥，真的来自他声称的那个人? 毕竟骗子太多了。
你也许受到了前面的启发：在公钥后面再加上主人的信息比如署名, 并用私钥签名一起公开，不就可以了吗？
但是别忘了，既然坏人能篡改公钥，那么署名和签名就可以一并篡改.
如果签名不可信，那么其它的信息都不可信. 如何让签名可信呢？

签名的本质，是使用私钥对某段公开信息加密，然后用对应的公钥来解密并校验.
私钥我拿不到，如果公钥是可信的，那么签名就可信，继而信息也是可信的。
所以这里的核心，是要让签名对应的公钥可信。

很快你又意识到，对信息进行签名的，未必一定要是周星星本人。
比如上面的分手信，周星星署名后，交给周润发. 周润发用自己的私钥签名，并托人转给朱茵茵。
朱茵茵看到信，将信将疑。但她很快注意到周润发的签名，并且由于周润发的公钥
